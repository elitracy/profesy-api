{"version":3,"sources":["../../../src/commands/utils/extractTemplateAppAsync.ts"],"names":["escapeXMLCharacters","original","noAmps","replace","noLt","noGt","noApos","Transformer","Minipass","constructor","config","settings","write","data","getNormalizedName","includes","extension","name","end","replaced","IOSConfig","XcodeUtils","sanitizedName","toLowerCase","binaryExtensions","createFileTransform","transformFile","entry","path","extname","undefined","extractAndPrepareTemplateAppAsync","templateSpec","projectRoot","extractTemplateAppAsync","expo","appFile","JsonFile","join","appJson","readAsync","writeAsync","packageFile","packageJson","inputName","sanitizeNpmPackageName","version","private","description","tags","repository","_resolved","_integrity","_from","applyKnownNpmPackageNameRules","test","substring","normalize","targetPath","pacote","tarball","stream","tarStream","extractTemplateAppAsyncImpl","cache","UserSettings","dotExpoHomeDirectory","extractTemplateAppFolderAsync","tarFilePath","readStream","fs","createReadStream","createEntryResolver","type","basename","mkdirp","Promise","resolve","reject","extractStream","tar","x","cwd","strip","transform","onentry","on","pipe"],"mappings":"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","sourcesContent":["import { BareAppConfig, ExpoConfig } from '@expo/config';\nimport { IOSConfig } from '@expo/config-plugins';\nimport JsonFile from '@expo/json-file';\nimport fs from 'fs-extra';\nimport merge from 'lodash/merge';\nimport Minipass from 'minipass';\nimport pacote, { PackageSpec } from 'pacote';\nimport path from 'path';\nimport slugify from 'slugify';\nimport { Readable } from 'stream';\nimport tar, { ReadEntry } from 'tar';\nimport { UserSettings } from 'xdl';\n\ntype AppJsonInput = { expo: Partial<ExpoConfig> & { name: string } };\ntype TemplateConfig = { name: string };\n\nfunction escapeXMLCharacters(original: string): string {\n  const noAmps = original.replace('&', '&amp;');\n  const noLt = noAmps.replace('<', '&lt;');\n  const noGt = noLt.replace('>', '&gt;');\n  const noApos = noGt.replace('\"', '\\\\\"');\n  return noApos.replace(\"'\", \"\\\\'\");\n}\n\nclass Transformer extends Minipass {\n  data = '';\n\n  constructor(public config: TemplateConfig, private settings: { extension: string }) {\n    super();\n  }\n\n  write(data: string) {\n    this.data += data;\n    return true;\n  }\n\n  getNormalizedName(): string {\n    if (['.xml', '.plist'].includes(this.settings.extension)) {\n      return escapeXMLCharacters(this.config.name);\n    }\n    return this.config.name;\n  }\n\n  end() {\n    const name = this.getNormalizedName();\n    const replaced = this.data\n      .replace(/Hello App Display Name/g, name)\n      .replace(/HelloWorld/g, IOSConfig.XcodeUtils.sanitizedName(name))\n      .replace(/helloworld/g, IOSConfig.XcodeUtils.sanitizedName(name.toLowerCase()));\n    super.write(replaced);\n    return super.end();\n  }\n}\n\n// Binary files, don't process these (avoid decoding as utf8)\nconst binaryExtensions = ['.png', '.jar', '.keystore', '.otf', '.ttf'];\n\nexport function createFileTransform(config: TemplateConfig) {\n  return function transformFile(entry: ReadEntry) {\n    const extension = path.extname(entry.path);\n    if (!binaryExtensions.includes(extension) && config.name) {\n      return new Transformer(config, { extension });\n    }\n    return undefined;\n  };\n}\n\n/**\n * Extract a template app to a given file path and clean up any properties left over from npm to\n * prepare it for usage.\n */\nexport async function extractAndPrepareTemplateAppAsync(\n  templateSpec: PackageSpec,\n  projectRoot: string,\n  config: AppJsonInput | BareAppConfig\n) {\n  await extractTemplateAppAsync(templateSpec, projectRoot, {\n    name: 'name' in config ? config.name : config.expo.name,\n  });\n\n  const appFile = new JsonFile(path.join(projectRoot, 'app.json'));\n  const appJson = merge(await appFile.readAsync(), config);\n  await appFile.writeAsync(appJson);\n\n  const packageFile = new JsonFile(path.join(projectRoot, 'package.json'));\n  const packageJson = await packageFile.readAsync();\n  // name and version are required for yarn workspaces (monorepos)\n  const inputName = 'name' in config ? config.name : config.expo.name;\n  packageJson.name = sanitizeNpmPackageName(inputName);\n  // These are metadata fields related to the template package, let's remove them from the package.json.\n  // A good place to start\n  packageJson.version = '1.0.0';\n  packageJson.private = true;\n\n  delete packageJson.description;\n  delete packageJson.tags;\n  delete packageJson.repository;\n  // pacote adds these, but we don't want them in the package.json of the project.\n  delete packageJson._resolved;\n  delete packageJson._integrity;\n  delete packageJson._from;\n\n  await packageFile.writeAsync(packageJson);\n\n  return projectRoot;\n}\n\nexport function sanitizeNpmPackageName(name: string): string {\n  // https://github.com/npm/validate-npm-package-name/#naming-rules\n  return (\n    applyKnownNpmPackageNameRules(name) ||\n    applyKnownNpmPackageNameRules(slugify(name)) ||\n    // If nothing is left use 'app' like we do in Xcode projects.\n    'app'\n  );\n}\n\nfunction applyKnownNpmPackageNameRules(name: string): string | null {\n  // https://github.com/npm/validate-npm-package-name/#naming-rules\n\n  // package name cannot start with '.' or '_'.\n  while (/^(\\.|_)/.test(name)) {\n    name = name.substring(1);\n  }\n\n  name = name.toLowerCase().replace(/[^a-zA-Z._\\-/@]/g, '');\n\n  return (\n    name\n      // .replace(/![a-z0-9-._~]+/g, '')\n      // Remove special characters\n      .normalize('NFD')\n      .replace(/[\\u0300-\\u036f]/g, '') || null\n  );\n}\n\n/**\n * Extract a template app to a given file path.\n */\nexport async function extractTemplateAppAsync(\n  templateSpec: PackageSpec,\n  targetPath: string,\n  config: TemplateConfig\n) {\n  await pacote.tarball.stream(\n    templateSpec,\n    tarStream => {\n      return extractTemplateAppAsyncImpl(targetPath, config, tarStream);\n    },\n    {\n      cache: path.join(UserSettings.dotExpoHomeDirectory(), 'template-cache'),\n    }\n  );\n\n  return targetPath;\n}\n\nexport async function extractTemplateAppFolderAsync(\n  tarFilePath: string,\n  targetPath: string,\n  config: TemplateConfig\n) {\n  const readStream = fs.createReadStream(tarFilePath);\n  await extractTemplateAppAsyncImpl(targetPath, config, readStream);\n  return targetPath;\n}\n\nexport function createEntryResolver(name: string) {\n  return (entry: ReadEntry) => {\n    if (name) {\n      // Rewrite paths for bare workflow\n      entry.path = entry.path\n        .replace(\n          /HelloWorld/g,\n          entry.path.includes('android')\n            ? IOSConfig.XcodeUtils.sanitizedName(name.toLowerCase())\n            : IOSConfig.XcodeUtils.sanitizedName(name)\n        )\n        .replace(/helloworld/g, IOSConfig.XcodeUtils.sanitizedName(name).toLowerCase());\n    }\n    if (entry.type && /^file$/i.test(entry.type) && path.basename(entry.path) === 'gitignore') {\n      // Rename `gitignore` because npm ignores files named `.gitignore` when publishing.\n      // See: https://github.com/npm/npm/issues/1862\n      entry.path = entry.path.replace(/gitignore$/, '.gitignore');\n    }\n  };\n}\n\nasync function extractTemplateAppAsyncImpl(\n  targetPath: string,\n  config: TemplateConfig,\n  tarStream: Readable\n) {\n  await fs.mkdirp(targetPath);\n  await new Promise((resolve, reject) => {\n    const extractStream = tar.x({\n      cwd: targetPath,\n      strip: 1,\n      // TODO(ville): pending https://github.com/DefinitelyTyped/DefinitelyTyped/pull/36598\n      transform: createFileTransform(config),\n      onentry: createEntryResolver(config.name),\n    });\n    tarStream.on('error', reject);\n    extractStream.on('error', reject);\n    extractStream.on('close', resolve);\n    tarStream.pipe(extractStream);\n  });\n}\n"],"file":"extractTemplateAppAsync.js"}